{% extends "baseForAdmin.html.twig" %}

{% block title %}
    Payer frais
{% endblock %}

{% block script %}
    <script language="JavaScript">
        function show() {
            $("#paiement").slideDown();
            $("#submitContainer").slideDown();
        }

        function show2() {
            $("#paiement2").slideDown();

        }
        $("document").ready(function () {

            $("#numChequeTot").blur(function () {
                $("#submitTotContainer").slideDown();
            });

            $("#payerTotForm").submit(function () {
                console.log($("#payerTotForm").serialize());
                $.ajax({
                    url: "{{ path('ajouterPaiementTot') }}" + "?idTranche=" + $("#idTranche").val(),
                    method: "GET",
                    data: $("#payerTotForm").serialize(),
                    success: function (response) {
                        response = JSON.parse(response);
                        console.log(response);
                        var message = "<div class='alert alert-success'>Payé avec success!!</div>";
                        $("#messageContainer").html(message);
                        setTimeout(function () {

                            window.location.assign("{{ path('consulterPaiements') }}" + "?idParent=" +{{ paiement.eleve.parent.id }});
                        }, 1500);
                    }
                });
            });


            $("#formPayer").submit(function () {
                console.log($("#formPayer").serialize());
                $.ajax({
                    url: "{{ path('ajouterPaiement') }}" + "?idTranche=" + $("#idTranche").val(),
                    method: "GET",
                    data: $("#formPayer").serialize(),
                    success: function (response) {
                        response = JSON.parse(response);
                        console.log(response);
                        var message = "<div class='alert alert-success'>Payé avec success!!</div>";
                        $("#messageContainer").html(message);
                        setTimeout(function () {

                            window.location.assign("{{ path('consulterPaiements') }}" + "?idParent=" +{{ paiement.eleve.parent.id }});
                        }, 1500);
                    }
                });
            });

            $("#typePaiementTot").change(function () {
                if ($("#typePaiementTot").val() == "null") {
                    var message = "<div class='alert alert-danger'>SVP choisir!</div>";
                    $("#payerVirementContainer").fadeOut();
                    $("#payerEspeceContainer").fadeOut();
                    $("#payerChequeContainer").fadeOut();
                    $("#formPayer")[0].reset();
                    $("#messageContainer").html(message);
                } else {
                    if ($("#typePaiementTot").val() == "virement") {
                        console.log("virement");
                        $("#payerEspeceTotContainer").fadeOut();
                        $("#payerChequeTotContainer").fadeOut();
                        $("#payerVirementTotContainer").slideDown();

                    } else {
                        if ($("#typePaiementTot").val() == "espece") {
                            $("#payerEspeceTotContainer").slideDown();
                            $("#payerChequeTotContainer").fadeOut();
                            $("#payerVirementTotContainer").fadeOut();

                        } else {
                            $("#payerEspeceTotContainer").fadeOut();
                            $("#payerChequeTotContainer").slideDown();
                            $("#payerVirementTotContainer").fadeOut();

                        }

                    }
                }
            });

            $("#typePaiement2").change(function () {
                if ($("#typePaiement2").val() == "null") {
                    var message = "<div class='alert alert-danger'>SVP choisir!</div>";
                    $("#payerVirementContainer").fadeOut();
                    $("#payerEspeceContainer").fadeOut();
                    $("#payerChequeContainer").fadeOut();
                    $("#formPayer")[0].reset();
                    $("#messageContainer").html(message);
                } else {
                    if ($("#typePaiement2").val() == "virement") {
                        $("#payerEspeceContainer").fadeOut();
                        $("#payerChequeContainer").fadeOut();
                        $("#payerVirementContainer").slideDown();

                    } else {
                        if ($("#typePaiement2").val() == "espece") {
                            $("#payerEspeceContainer").slideDown();
                            $("#payerChequeContainer").fadeOut();
                            $("#payerVirementContainer").fadeOut();

                        } else {
                            $("#payerEspeceContainer").fadeOut();
                            $("#payerChequeContainer").slideDown();
                            $("#payerVirementContainer").fadeOut();

                        }

                    }
                }
            });


            $("#typePaiement").change(function () {
                $("#messageContainer").html("");
                if ($("#typePaiement").val() == "null") {
                    var message = "<div class='alert alert-danger'>SVP choisir!</div>";
                    $("#payerTranchesContainer").fadeOut();
                    $("#payerTotaliteContainer").fadeOut();
                    $("#messageContainer").html(message);
                } else {
                    if ($("#typePaiement").val() == "totalite") {
                        $("#payerTranchesContainer").fadeOut();

                        $.ajax({
                            url: "{{ path('ajouterTranches') }}",
                            method: "GET",
                            data: {
                                "idPaiement": $("#idPaiementHidden").val(),
                                "typePaiement": $("#typePaiement").val()
                            },
                            success: function (response) {
                                response = JSON.parse(response);
                                console.log(response);
                                if (response.status == "mawjoud") {
                                    var tranche = "<input type='text' value='" + response.tranche[0].id + "' id='idTranche'>";
                                    $("#trancheContainer").html(tranche);
                                    var tableau = "<table class='table table-bordered'><tr class='table-header'><td>N° Tranche</td><td>Montant Tranche</td><td>Etat</td><td>Payer</td></tr>";
                                    tableau += "<tr><td>" + response.tranche[0].numero_tranche + "</td><td>" + response.tranche[0].montant_tranche + "</td><td>" + response.tranche[0].etat_tranche + "</td>";
                                    if (response.tranche[0].etat_tranche == "non payé") {
                                        tableau += "<td><input type='button' value='payer' onclick='show2()' class='btn btn-primary'></td></tr>";
                                    } else {
                                        tableau += "<td>Payé</td>";
                                    }
                                } else {
                                    var tranche = "<input type='text' value='" + response.tranches.id + "' id='idTranche'>";
                                    $("#trancheContainer").html(tranche);
                                    var tableau = "<table class='table table-bordered'><tr class='table-header'><td>N° Tranche</td><td>Montant Tranche</td><td>Etat</td><td>Payer</td></tr>";
                                    tableau += "<tr><td>" + response.tranches.numero_tranche + "</td><td>" + response.tranches.montant_tranche + "</td><td>" + response.tranches.etat_tranche + "</td>";
                                    if (response.tranches.etat_tranche == "non payé") {
                                        tableau += "<td><input type='button' value='payer' onclick='show2()' class='btn btn-primary'></td></tr>";
                                    } else {
                                        tableau += "<td>Payé</td>";
                                    }
                                }
                                tableau += "</table>";
                                $("#tableauTrancheContainer").html(tableau);

                            }
                        });

                        $("#payerTotaliteContainer").slideDown();
                    } else {
                        $("#payerTotaliteContainer").fadeOut();
                        $.ajax({
                            url: "{{ path('ajouterTranches') }}",
                            method: "GET",
                            data: {
                                "idPaiement": $("#idPaiementHidden").val(),
                                "typePaiement": $("#typePaiement").val()
                            },
                            success: function (response) {
                                response = JSON.parse(response);
                                console.log(response);
                                var tableau = "<table class='table table-bordered'><tr class='table-header'><td>N° Tranche</td><td>Montant Tranche</td><td>Etat</td><td>Payer</td></tr>";
                                var tranche = "";
                                $.each(response.listTranches, function (i, item) {
                                    tranche = "<input type='text' value='" + item.id + "' id='idTranche'>";
                                    tableau += "<tr><td>" + item.numero_tranche + "</td><td>" + item.montant_tranche + "</td><td>" + item.etat_tranche + "</td>";
                                    if (item.etat_tranche == "non payé") {
                                        tableau += "<td><input type='button' value='payer' onclick='show()' class='btn btn-primary'></td></tr>";
                                    } else {
                                        tableau += "<td>Payé</td>";
                                    }
                                });

                                tableau += "</table>";

                                $("#tableauTranchesContainer").html(tableau);
                                $("#trancheContainer").html(tranche);
                            }

                        });
                        $("#payerTranchesContainer").slideDown();

                    }
                }
            });


        });
    </script>
{% endblock %}

{% block mainContent %}

    <hr class="hr-4">
    <div class="col-xs-12">
        <div id="messageContainer">

        </div>
        <center><h4>Frais : {{ paiement.fraisPaiement }}, Montant : {{ paiement.totalePaiement }}, pour l'eleve
                : {{ paiement.eleve.prenomEleve }} {{ paiement.eleve.nomEleve }}</h4></center>
        <div class="row" align="center">

            <div id="trancheContainer" style="display: none">

            </div>
            <input type="text" value="{{ paiement.id }}" style="display: none" id="idPaiementHidden">
            Payer : <select id="typePaiement" name="idPaiement">
                <option value="null">Choisir</option>
                {% if typePaiement is defined %}
                    <option value="{{ typePaiement }}">{{ typePaiement }}</option>
                {% else %}
                    <option value="totalite">La totalité</option>
                    <option value="tranches">Par tranches</option>
                {% endif %}
            </select>
            <div id="payerTranchesContainer" style="display: none">
                <center><h4>Paiement par tranches</h4></center>
                <form name="formPayer" id="formPayer" onsubmit="return false" action="#">
                    <div id="tableauTranchesContainer">

                    </div>
                    <div id="paiement" style="display: none" align="center">
                        <center><h4>Type Paiement</h4></center>
                        <select name="typePaiement2" id="typePaiement2">
                            <option value="null"> Choisir</option>
                            <option value="virement">Virement bancaire</option>
                            <option value="espece">Espèce</option>
                            <option value="cheque">Par chèque</option>
                        </select>
                    </div>

                    <div id="payerVirementContainer" style="display: none" align="center">
                        <center><h4>Payer par virement bancaire</h4></center>
                        <table class="table table-bordered" border="1" width="50%">
                            <tr>
                                <td width="50%">Upload</td>
                                <td width="50%"><input type="file" name="fichierVirement"></td>
                            </tr>
                        </table>
                    </div>

                    <div id="payerEspeceContainer" style="display: none">
                        <center><h4>Payer en espèce</h4></center>
                    </div>

                    <div id="payerChequeContainer" style="display: none">
                        <center><h4>Payer par cheque</h4></center>
                        <table class="table table-bordered" border="1">
                            <tr>
                                <td>Nom banque</td>
                                <td><input type="text" name="nomBanque"></td>
                            </tr>
                            <tr>
                                <td>N° chèque</td>
                                <td><input type="text" name="numCheque"></td>
                            </tr>
                        </table>
                    </div>
                    <div id="submitContainer" style="display: none">
                        <input type="submit">
                    </div>
                </form>

            </div>

            <div id="payerTotaliteContainer" style="display: none">
                <form name="payerTotForm" id="payerTotForm" action="#" onsubmit="return false">
                    <div id="tableauTrancheContainer">

                    </div>
                    <div id="paiement2" style="display: none" align="center">
                        <center><h4>Type Paiement</h4></center>
                        <select name="typePaiementTot" id="typePaiementTot">
                            <option value="null"> Choisir</option>


                            <option value="virement">Virement bancaire</option>
                            <option value="espece">Espèce</option>
                            <option value="cheque">Par chèque</option>

                        </select>
                    </div>

                    <div id="payerVirementTotContainer" style="display: none" align="center">
                        <center><h4>Payer par virement bancaire</h4></center>
                        <table class="table table-bordered" border="1" width="50%">
                            <tr>
                                <td width="50%">Upload</td>
                                <td width="50%"><input type="file" name="fichierVirementTot"></td>
                            </tr>
                        </table>
                    </div>

                    <div id="payerEspeceTotContainer" style="display: none">
                        <center><h4>Payer en espèce</h4></center>
                        <input type="submit">
                    </div>

                    <div id="payerChequeTotContainer" style="display: none">
                        <center><h4>Payer par cheque</h4></center>
                        <table class="table table-bordered" border="1">
                            <tr>
                                <td>Nom banque</td>
                                <td><input type="text" name="nomBanqueTot"></td>
                            </tr>
                            <tr>
                                <td>N° chèque</td>
                                <td><input type="text" name="numChequeTot" id="numChequeTot"></td>
                            </tr>
                        </table>
                    </div>
                    <div id="submitTotContainer" style="display: none">
                        <input type="submit">
                    </div>
                </form>
            </div>


        </div>
    </div>
{% endblock %}